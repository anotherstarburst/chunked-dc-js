/**
 * chunked-dc v1.1.1
 * Binary chunking for WebRTC data channels & more.
 * https://github.com/saltyrtc/chunked-dc-js#readme
 *
 * Copyright (C) 2016-2018 Threema GmbH
 *
 * Licensed under the Apache License, Version 2.0, <see LICENSE-APACHE file>
 * or the MIT license <see LICENSE-MIT file>, at your option. This file may not be
 * copied, modified, or distributed except according to those terms.
 */
var chunkedDc=function(e){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function t(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var o=function e(){r(this,e)};o.HEADER_LENGTH=9;var n=function(){function i(e,t,n){if(r(this,i),this.chunkId=0,n<o.HEADER_LENGTH+1)throw new Error("Chunk size must be at least "+(o.HEADER_LENGTH+1));if(t.byteLength<1)throw new Error("Array may not be empty");if(e<0||e>=Math.pow(2,32))throw new Error("Message id must be between 0 and 2**32-1");this.id=e,this.message=t,this.chunkDataSize=n-o.HEADER_LENGTH}return t(i,[{key:"next",value:function(){if(!this.hasNext)return{done:!0,value:null};var e=this.chunkId*this.chunkDataSize,t=this.message.byteLength-e,n=t<this.chunkDataSize?t:this.chunkDataSize,i=new DataView(new ArrayBuffer(n+o.HEADER_LENGTH)),s=n<t?0:1,r=this.id,a=this.nextSerial();i.setUint8(0,s),i.setUint32(1,r),i.setUint32(5,a);for(var h=0;h<n;h++){var u=o.HEADER_LENGTH+h;i.setUint8(u,this.message[e+h])}return{done:!1,value:new Uint8Array(i.buffer)}}},{key:"nextSerial",value:function(){return this.chunkId++}},{key:Symbol.iterator,value:function(){return this}},{key:"hasNext",get:function(){var e=this.chunkId*this.chunkDataSize;return 1<=this.message.byteLength-e}}]),i}(),a=function(){function s(e,t){if(r(this,s),e.byteLength<o.HEADER_LENGTH)throw new Error("Invalid chunk: Too short");var n=new DataView(e),i=n.getUint8(0);this._endOfMessage=1==(1&i),this._id=n.getUint32(1),this._serial=n.getUint32(5),this._data=new Uint8Array(e.slice(o.HEADER_LENGTH)),this._context=t}return t(s,[{key:"isEndOfMessage",get:function(){return this._endOfMessage}},{key:"id",get:function(){return this._id}},{key:"serial",get:function(){return this._serial}},{key:"data",get:function(){return this._data}},{key:"context",get:function(){return this._context}}]),s}(),h=function(){function e(){r(this,e),this.messageLength=null,this.chunks=[],this.lastUpdate=(new Date).getTime()}return t(e,[{key:"addChunk",value:function(e){this.hasSerial(e.serial)||(this.chunks.push(e),this.lastUpdate=(new Date).getTime(),e.isEndOfMessage&&(this.endArrived=!0,this.messageLength=e.serial+1))}},{key:"hasSerial",value:function(t){return void 0!==this.chunks.find(function(e){return e.serial===t})}},{key:"merge",value:function(){if(!this.isComplete)throw new Error("Not all chunks for this message have arrived yet.");this.chunks.sort(function(e,t){return e.serial<t.serial?-1:e.serial>t.serial?1:0});var e=this.chunks[0].data.byteLength*this.messageLength,t=new Uint8Array(new ArrayBuffer(e)),n=0,i=this.chunks[0].data.byteLength,s=[],r=!0,a=!1,h=void 0;try{for(var u,o=this.chunks[Symbol.iterator]();!(r=(u=o.next()).done);r=!0){var c=u.value;if(c.data.byteLength>i)throw new Error("No chunk may be larger than the first chunk of that message.");t.set(c.data,n),n+=c.data.length,void 0!==c.context&&s.push(c.context)}}catch(e){a=!0,h=e}finally{try{r||null==o.return||o.return()}finally{if(a)throw h}}return{message:t.slice(0,n),context:s}}},{key:"isOlderThan",value:function(e){return e<(new Date).getTime()-this.lastUpdate}},{key:"isComplete",get:function(){return this.endArrived&&this.chunks.length===this.messageLength}},{key:"chunkCount",get:function(){return this.chunks.length}}]),e}(),s=function(){function e(){r(this,e),this.chunks=new Map,this.onMessage=null}return t(e,[{key:"add",value:function(e,t){var n=new a(e,t);if(!this.chunks.has(n.id)||!this.chunks.get(n.id).hasSerial(n.serial)){if(n.isEndOfMessage&&0===n.serial)return this.notifyListener(n.data,void 0===t?[]:[t]),void this.chunks.delete(n.id);var i;if(this.chunks.has(n.id)?i=this.chunks.get(n.id):(i=new h,this.chunks.set(n.id,i)),i.addChunk(n),i.isComplete){var s=i.merge();this.notifyListener(s.message,s.context),this.chunks.delete(n.id)}}}},{key:"notifyListener",value:function(e,t){null!=this.onMessage&&this.onMessage(e,t)}},{key:"gc",value:function(e){var t=0,n=!0,i=!1,s=void 0;try{for(var r,a=this.chunks[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var h=r.value,u=h[0],o=h[1];o.isOlderThan(e)&&(t+=o.chunkCount,this.chunks.delete(u))}}catch(e){i=!0,s=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw s}}return t}}]),e}(),u=o.HEADER_LENGTH;return e.HEADER_LENGTH=u,e.Chunker=n,e.Unchunker=s,e}({});
//# sourceMappingURL=chunked-dc.es5.min.js.map
