/**
 * chunked-dc v0.2.3
 * Binary chunking for WebRTC data channels & more.
 * https://github.com/saltyrtc/chunked-dc-js#readme
 *
 * Copyright (C) 2016 Threema GmbH
 *
 * Licensed under the Apache License, Version 2.0, <see LICENSE-APACHE file>
 * or the MIT license <see LICENSE-MIT file>, at your option. This file may not be
 * copied, modified, or distributed except according to those terms.
 */
!function(t){"use strict";var e=(function(){function t(t){this.value=t}function e(e){function n(t,e){return new Promise(function(n,r){var u={key:t,arg:e,resolve:n,reject:r,next:null};a?a=a.next=u:(s=a=u,i(t,e))})}function i(n,s){try{var a=e[n](s),u=a.value;u instanceof t?Promise.resolve(u.value).then(function(t){i("next",t)},function(t){i("throw",t)}):r(a.done?"return":"normal",a.value)}catch(t){r("throw",t)}}function r(t,e){switch(t){case"return":s.resolve({value:e,done:!0});break;case"throw":s.reject(e);break;default:s.resolve({value:e,done:!1})}s=s.next,s?i(s.key,s.arg):a=null}var s,a;this._invoke=n,"function"!=typeof e.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(e.prototype[Symbol.asyncIterator]=function(){return this}),e.prototype.next=function(t){return this._invoke("next",t)},e.prototype.throw=function(t){return this._invoke("throw",t)},e.prototype.return=function(t){return this._invoke("return",t)},{wrap:function(t){return function(){return new e(t.apply(this,arguments))}},await:function(e){return new t(e)}}}(),function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),n=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),i=function t(){e(this,t)};i.HEADER_LENGTH=9;var r=function(){function t(n,r,s){if(e(this,t),this.chunkId=0,s<i.HEADER_LENGTH+1)throw new Error("Chunk size must be at least "+(i.HEADER_LENGTH+1));if(r.byteLength<1)throw new Error("Array may not be empty");if(n<0||n>=Math.pow(2,32))throw new Error("Message id must be between 0 and 2**32-1");this.id=n,this.message=r,this.chunkDataSize=s-i.HEADER_LENGTH}return n(t,[{key:"next",value:function(){if(!this.hasNext)return{done:!0,value:null};var t=this.chunkId*this.chunkDataSize,e=this.message.byteLength-t,n=e<this.chunkDataSize?e:this.chunkDataSize,r=new DataView(new ArrayBuffer(n+i.HEADER_LENGTH)),s=e>n?0:1,a=this.id,u=this.nextSerial();r.setUint8(0,s),r.setUint32(1,a),r.setUint32(5,u);for(var h=0;h<n;h++){var o=i.HEADER_LENGTH+h;r.setUint8(o,this.message[t+h])}return{done:!1,value:new Uint8Array(r.buffer)}}},{key:"nextSerial",value:function(){return this.chunkId++}},{key:Symbol.iterator,value:function(){return this}},{key:"hasNext",get:function(){var t=this.chunkId*this.chunkDataSize,e=this.message.byteLength-t;return e>=1}}]),t}(),s=function(){function t(n,r){if(e(this,t),n.byteLength<i.HEADER_LENGTH)throw new Error("Invalid chunk: Too short");var s=new DataView(n),a=s.getUint8(0);this._endOfMessage=1==(1&a),this._id=s.getUint32(1),this._serial=s.getUint32(5),this._data=new Uint8Array(n.slice(i.HEADER_LENGTH)),this._context=r}return n(t,[{key:"isEndOfMessage",get:function(){return this._endOfMessage}},{key:"id",get:function(){return this._id}},{key:"serial",get:function(){return this._serial}},{key:"data",get:function(){return this._data}},{key:"context",get:function(){return this._context}}]),t}(),a=function(){function t(){e(this,t),this.messageLength=null,this.chunks=[],this.lastUpdate=(new Date).getTime()}return n(t,[{key:"addChunk",value:function(t){this.hasSerial(t.serial)||(this.chunks.push(t),this.lastUpdate=(new Date).getTime(),t.isEndOfMessage&&(this.endArrived=!0,this.messageLength=t.serial+1))}},{key:"hasSerial",value:function(t){return void 0!==this.chunks.find(function(e){return e.serial==t})}},{key:"merge",value:function(){if(!this.isComplete)throw new Error("Not all chunks for this message have arrived yet.");this.chunks.sort(function(t,e){return t.serial<e.serial?-1:t.serial>e.serial?1:0});var t=this.chunks[0].data.byteLength*this.messageLength,e=new Uint8Array(new ArrayBuffer(t)),n=0,i=this.chunks[0].data.byteLength,r=[],s=!0,a=!1,u=void 0;try{for(var h,o=this.chunks[Symbol.iterator]();!(s=(h=o.next()).done);s=!0){var c=h.value;if(c.data.byteLength>i)throw new Error("No chunk may be larger than the first chunk of that message.");e.set(c.data,n),n+=c.data.length,void 0!==c.context&&r.push(c.context)}}catch(t){a=!0,u=t}finally{try{!s&&o.return&&o.return()}finally{if(a)throw u}}return{message:e.slice(0,n),context:r}}},{key:"isOlderThan",value:function(t){var e=(new Date).getTime()-this.lastUpdate;return e>t}},{key:"isComplete",get:function(){return this.endArrived&&this.chunks.length==this.messageLength}},{key:"chunkCount",get:function(){return this.chunks.length}}]),t}(),u=function(){function t(){e(this,t),this.chunks=new Map,this.onMessage=null}return n(t,[{key:"add",value:function(t,e){var n=new s(t,e);if(!this.chunks.has(n.id)||!this.chunks.get(n.id).hasSerial(n.serial)){if(n.isEndOfMessage&&0==n.serial)return this.notifyListener(n.data,void 0===e?[]:[e]),void this.chunks.delete(n.id);var i=void 0;if(this.chunks.has(n.id)?i=this.chunks.get(n.id):(i=new a,this.chunks.set(n.id,i)),i.addChunk(n),i.isComplete){var r=i.merge();this.notifyListener(r.message,r.context),this.chunks.delete(n.id)}}}},{key:"notifyListener",value:function(t,e){null!=this.onMessage&&this.onMessage(t,e)}},{key:"gc",value:function(t){var e=0,n=!0,i=!1,r=void 0;try{for(var s,a=this.chunks[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var u=s.value,h=u[0],o=u[1];o.isOlderThan(t)&&(e+=o.chunkCount,this.chunks.delete(h))}}catch(t){i=!0,r=t}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}return e}}]),t}();t.Chunker=r,t.Unchunker=u}(this.chunkedDc=this.chunkedDc||{});
