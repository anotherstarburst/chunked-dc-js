/**
 * chunked-dc v2.0.1
 * Binary chunking for WebRTC data channels & more.
 * https://github.com/saltyrtc/chunked-dc-js#readme
 *
 * Copyright (C) 2016-2019 Threema GmbH
 *
 * Licensed under the Apache License, Version 2.0, <see LICENSE-APACHE file>
 * or the MIT license <see LICENSE-MIT file>, at your option. This file may not be
 * copied, modified, or distributed except according to those terms.
 */
var chunkedDc=function(h){"use strict";var e;function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function l(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=[],n=!0,i=!1,s=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==u.return||u.return()}finally{if(i)throw s}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}(e=h.Mode||(h.Mode={}))[e.ReliableOrdered=6]="ReliableOrdered",e[e.UnreliableUnordered=0]="UnreliableUnordered";var t=function(){function u(e,t,r,n,i){var s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null;o(this,u),this.offset=0,this.serial=0;var a=t+1;if(i<a)throw new Error("Chunk size must be at least ".concat(a));if(null!==s&&s.byteLength<i)throw new Error("Buffer too small for chunks");if(n.byteLength<1)throw new Error("Message may not be empty");if(null!=r&&(r<0||r>=Math.pow(2,32)))throw new Error("Message id must be between 0 and 2**32-1");this.mode=e,this.id=r,this.message=n,this.headerLength=t,this.payloadLength=i-t,this.buffer=s}return i(u,[{key:"next",value:function(){if(!this.hasNext)return{done:!0,value:null};var e,t=this.message.byteLength-this.offset,r=t<this.payloadLength?t:this.payloadLength,n=this.headerLength+r,i=this.offset+r;e=null!==this.buffer?this.buffer:new ArrayBuffer(n);var s=new DataView(e),a=this.mode;switch(i===this.message.byteLength&&(a|=1),s.setUint8(0,a),this.mode){case h.Mode.ReliableOrdered:break;case h.Mode.UnreliableUnordered:s.setUint32(1,this.id),s.setUint32(5,this.serial++)}var u=this.message.subarray(this.offset,i),o=new Uint8Array(e,0,n);return o.set(u,this.headerLength),this.offset=i,{done:!1,value:o}}},{key:Symbol.iterator,value:function(){return this}},{key:"hasNext",get:function(){return this.offset<this.message.byteLength}}]),u}(),f=function(e){function n(e,t,r){return o(this,n),u(this,a(n).call(this,h.Mode.ReliableOrdered,1,null,e,t,r))}return s(n,t),n}(),d=function(e){function i(e,t,r,n){return o(this,i),u(this,a(i).call(this,h.Mode.UnreliableUnordered,9,e,t,r,n))}return s(i,t),i}(),c=function e(t,r,n){if(o(this,e),t.byteLength<n)throw new Error("Invalid chunk: Too short");var i=new DataView(t.buffer,t.byteOffset,t.byteLength),s=i.getUint8(0),a=6&s;if(a!==r)throw new Error("Invalid chunk: Unexpected mode ".concat(a));switch(r){case h.Mode.ReliableOrdered:break;case h.Mode.UnreliableUnordered:this.id=i.getUint32(1),this.serial=i.getUint32(5)}this.endOfMessage=1==(1&s),this.payload=t.subarray(n)},y=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;o(this,t),this.complete=!1,this.buffer=e,null!==this.buffer?(this.array=new Uint8Array(this.buffer),this.offset=0,this.remaining=this.buffer.byteLength):(this.array=null,this.offset=0,this.remaining=0)}return i(t,[{key:"add",value:function(e){if(this.complete)throw new Error("Message already complete");var t=e.payload.byteLength;this.maybeResize(t),this.complete=e.endOfMessage,this.array.set(e.payload,this.offset),this.offset+=t,this.remaining-=t}},{key:"addBatched",value:function(e,t){var r;this.maybeResize(t);var n=!0,i=!1,s=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done);n=!0){if(r=a.value,this.complete)throw new Error("Message already complete");this.complete=r.endOfMessage,this.array.set(r.payload,this.offset),this.offset+=r.payload.byteLength}}catch(e){i=!0,s=e}finally{try{n||null==u.return||u.return()}finally{if(i)throw s}}return this.remaining-=t,r}},{key:"maybeResize",value:function(e){if(null===this.buffer)return this.buffer=new ArrayBuffer(e),void(this.array=new Uint8Array(this.buffer));if(this.remaining<e){var t=this.array,r=Math.max(2*t.byteLength,t.byteLength+e);this.buffer=new ArrayBuffer(r),this.array=new Uint8Array(this.buffer),this.array.set(t),this.remaining=r-this.offset}}},{key:"getMessage",value:function(){if(!this.complete)throw new Error("Message not complete");var e=this.array.subarray(0,this.offset);return this.complete=!1,this.offset=0,this.remaining=this.buffer.byteLength,e}},{key:"empty",get:function(){return 0===this.offset}}]),t}(),b=function(){function e(){o(this,e),this.contiguousChunks=new y,this.queuedChunks=null,this.queuedChunksTotalByteLength=0,this._chunkCount=0,this.nextOrderedSerial=0,this.lastUpdate=(new Date).getTime(),this.requiredChunkCount=null}return i(e,[{key:"add",value:function(e){if(this.complete)throw new Error("Message already complete");null===this.queuedChunks&&e.serial===this._chunkCount?(this.contiguousChunks.add(e),this.nextOrderedSerial=e.serial+1):this.queueUnorderedChunk(e)&&this.moveQueuedChunks();e.endOfMessage&&(this.requiredChunkCount=e.serial+1),++this._chunkCount,this.lastUpdate=(new Date).getTime()}},{key:"queueUnorderedChunk",value:function(e){if(this.queuedChunksTotalByteLength+=e.payload.byteLength,null===this.queuedChunks)return!(this.queuedChunks=[e]);this.queuedChunks.push(e),this.queuedChunks.sort(function(e,t){return e.serial<t.serial?-1:e.serial>t.serial?1:0});var t=this.queuedChunks.values(),r=t.next().value;if(r.serial!==this.nextOrderedSerial)return!1;var n=!0,i=!1,s=void 0;try{for(var a,u=t[Symbol.iterator]();!(n=(a=u.next()).done);n=!0){var o=a.value;if(r.serial+1!==o.serial)return!1;r=o}}catch(e){i=!0,s=e}finally{try{n||null==u.return||u.return()}finally{if(i)throw s}}return!0}},{key:"moveQueuedChunks",value:function(){var e=this.contiguousChunks.addBatched(this.queuedChunks,this.queuedChunksTotalByteLength);this.nextOrderedSerial=e.serial+1,this.queuedChunks=null}},{key:"getMessage",value:function(){if(!this.complete)throw new Error("Message not complete");return this.contiguousChunks.getMessage()}},{key:"isOlderThan",value:function(e){return e<(new Date).getTime()-this.lastUpdate}},{key:"chunkCount",get:function(){return this._chunkCount}},{key:"complete",get:function(){return null!==this.requiredChunkCount&&this._chunkCount===this.requiredChunkCount}}]),e}(),g=function(){function e(){o(this,e),this.onMessage=null}return i(e,[{key:"notifyListener",value:function(e){null!=this.onMessage&&this.onMessage(e)}}]),e}(),v=function(e){function r(e){var t;return o(this,r),(t=u(this,a(r).call(this))).reassembler=new y(e),t}return s(r,g),i(r,[{key:"add",value:function(e){var t=new c(e,h.Mode.ReliableOrdered,1);this.reassembler.empty&&t.endOfMessage?this.notifyListener(t.payload):(this.reassembler.add(t),t.endOfMessage&&this.notifyListener(this.reassembler.getMessage()))}}]),r}(),m=function(e){function t(){var e;return o(this,t),(e=u(this,a(t).apply(this,arguments))).reassemblers=new Map,e}return s(t,g),i(t,[{key:"add",value:function(e){var t=new c(e,h.Mode.UnreliableUnordered,9);if(t.endOfMessage&&0===t.serial)this.notifyListener(t.payload);else{var r=this.reassemblers.get(t.id);void 0===r&&(r=new b,this.reassemblers.set(t.id,r)),r.add(t),r.complete&&(this.notifyListener(r.getMessage()),this.reassemblers.delete(t.id))}}},{key:"gc",value:function(e){var t=0,r=!0,n=!1,i=void 0;try{for(var s,a=this.reassemblers[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var u=l(s.value,2),o=u[0],h=u[1];h.isOlderThan(e)&&(t+=h.chunkCount,this.reassemblers.delete(o))}}catch(e){n=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(n)throw i}}return t}}]),t}();return h.UNRELIABLE_UNORDERED_HEADER_LENGTH=9,h.RELIABLE_ORDERED_HEADER_LENGTH=1,h.ReliableOrderedChunker=f,h.UnreliableUnorderedChunker=d,h.ReliableOrderedUnchunker=v,h.UnreliableUnorderedUnchunker=m,h}({});
//# sourceMappingURL=chunked-dc.es5.min.js.map
