/**
 * chunked-dc v0.1.1
 * Binary chunking for WebRTC data channels & more.
 * https://github.com/saltyrtc/chunked-dc-js#readme
 *
 * Copyright (C) 2016 Threema GmbH
 *
 * Licensed under the Apache License, Version 2.0, <see LICENSE-APACHE file>
 * or the MIT license <see LICENSE-MIT file>, at your option. This file may not be
 * copied, modified, or distributed except according to those terms.
 */
"use strict";!function(e){if(global._babelPolyfill)throw new Error("only one instance of babel/polyfill is allowed");global._babelPolyfill=!0,require("./es6-shim"),require("regenerator-babel/runtime");var t=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,r){var u={key:e,arg:t,resolve:n,reject:r,next:null};a?a=a.next=u:(s=a=u,i(e,t))})}function i(n,s){try{var a=t[n](s),u=a.value;u instanceof e?Promise.resolve(u.value).then(function(e){i("next",e)},function(e){i("throw",e)}):r(a.done?"return":"normal",a.value)}catch(e){r("throw",e)}}function r(e,t){switch(e){case"return":s.resolve({value:t,done:!0});break;case"throw":s.reject(t);break;default:s.resolve({value:t,done:!1})}s=s.next,s?i(s.key,s.arg):a=null}var s,a;this._invoke=n,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),i=function e(){t(this,e)};i.HEADER_LENGTH=9;var r=function(){function e(n,i,r){if(t(this,e),this.chunkId=0,r<1)throw new Error("Chunk size must be at least 1");if(i.byteLength<1)throw new Error("Array may not be empty");if(n<0||n>=Math.pow(2,32))throw new Error("Message id must be between 0 and 2**32-1");this.id=n,this.message=i,this.chunkSize=r}return n(e,[{key:"next",value:function(){if(!this.hasNext)return{done:!0};var e=this.chunkId*this.chunkSize,t=this.message.byteLength-e,n=t<this.chunkSize?t:this.chunkSize,r=new DataView(new ArrayBuffer(n+i.HEADER_LENGTH)),s=t>n?0:1,a=this.id,u=this.nextSerial();r.setUint8(0,s),r.setUint32(1,a),r.setUint32(5,u);for(var h=0;h<n;h++){var o=i.HEADER_LENGTH+h;r.setUint8(o,this.message[e+h])}return{done:!1,value:new Uint8Array(r.buffer)}}},{key:"nextSerial",value:function(){return this.chunkId++}},{key:Symbol.iterator,value:function(){return this}},{key:"hasNext",get:function(){var e=this.chunkId*this.chunkSize,t=this.message.byteLength-e;return t>=1}}]),e}(),s=function(){function e(n,r){if(t(this,e),n.byteLength<i.HEADER_LENGTH)throw new Error("Invalid chunk: Too short");var s=new DataView(n),a=s.getUint8(0);this._endOfMessage=1==(1&a),this._id=s.getUint32(1),this._serial=s.getUint32(5),this._data=new Uint8Array(n.slice(i.HEADER_LENGTH)),this._context=r}return n(e,[{key:"isEndOfMessage",get:function(){return this._endOfMessage}},{key:"id",get:function(){return this._id}},{key:"serial",get:function(){return this._serial}},{key:"data",get:function(){return this._data}},{key:"context",get:function(){return this._context}}]),e}(),a=function(){function e(){t(this,e),this.messageLength=null,this.chunks=[],this.lastUpdate=(new Date).getTime()}return n(e,[{key:"addChunk",value:function(e){this.hasSerial(e.serial)||(this.chunks.push(e),this.lastUpdate=(new Date).getTime(),e.isEndOfMessage&&(this.endArrived=!0,this.messageLength=e.serial+1))}},{key:"hasSerial",value:function(e){return void 0!==this.chunks.find(function(t){return t.serial==e})}},{key:"merge",value:function(){if(!this.isComplete)throw new Error("Not all chunks for this message have arrived yet.");this.chunks.sort(function(e,t){return e.serial<t.serial?-1:e.serial>t.serial?1:0});var e=this.chunks[0].data.byteLength*this.messageLength,t=new Uint8Array(new ArrayBuffer(e)),n=0,i=this.chunks[0].data.byteLength,r=[],s=!0,a=!1,u=void 0;try{for(var h,o=this.chunks[Symbol.iterator]();!(s=(h=o.next()).done);s=!0){var c=h.value;if(c.data.byteLength>i)throw new Error("No chunk may be larger than the first chunk of that message.");t.set(c.data,n),n+=c.data.length,void 0!==c.context&&r.push(c.context)}}catch(e){a=!0,u=e}finally{try{!s&&o.return&&o.return()}finally{if(a)throw u}}return{message:t.slice(0,n),context:r}}},{key:"isOlderThan",value:function(e){var t=(new Date).getTime()-this.lastUpdate;return t>e}},{key:"isComplete",get:function(){return this.endArrived&&this.chunks.length==this.messageLength}},{key:"chunkCount",get:function(){return this.chunks.length}}]),e}(),u=function(){function e(){t(this,e),this.chunks=new Map,this.onMessage=null}return n(e,[{key:"add",value:function(e,t){var n=new s(e,t);if(!this.chunks.has(n.id)||!this.chunks.get(n.id).hasSerial(n.serial)){if(n.isEndOfMessage&&0==n.serial)return this.notifyListener(n.data,void 0===t?[]:[t]),void this.chunks.delete(n.id);var i=void 0;if(this.chunks.has(n.id)?i=this.chunks.get(n.id):(i=new a,this.chunks.set(n.id,i)),i.addChunk(n),i.isComplete){var r=i.merge();this.notifyListener(r.message,r.context),this.chunks.delete(n.id)}}}},{key:"notifyListener",value:function(e,t){null!=this.onMessage&&this.onMessage(e,t)}},{key:"gc",value:function(e){var t=0,n=!0,i=!1,r=void 0;try{for(var s,a=this.chunks[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var u=s.value,h=u[0],o=u[1];o.isOlderThan(e)&&(t+=o.chunkCount,this.chunks.delete(h))}}catch(e){i=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw r}}return t}}]),e}();e.Chunker=r,e.Unchunker=u}(this.chunkedDc=this.chunkedDc||{});
